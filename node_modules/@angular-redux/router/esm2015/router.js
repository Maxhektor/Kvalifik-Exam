/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { NgRedux } from '@angular-redux/store';
import { Location } from '@angular/common';
import { Injectable } from '@angular/core';
import { NavigationEnd, Router } from '@angular/router';
import { distinctUntilChanged, filter, map } from 'rxjs/operators';
import { UPDATE_LOCATION } from './actions';
export class NgReduxRouter {
    /**
     * @param {?} router
     * @param {?} ngRedux
     * @param {?} location
     */
    constructor(router, ngRedux, location) {
        this.router = router;
        this.ngRedux = ngRedux;
        this.location = location;
        this.initialized = false;
        this.selectLocationFromState = state => state.router;
    }
    /**
     * Destroys the bindings between \@angular-redux/router and \@angular/router.
     * This method unsubscribes from both \@angular-redux/router and \@angular router, in case
     * your app needs to tear down the bindings without destroying Angular or Redux
     * at the same time.
     * @return {?}
     */
    destroy() {
        if (this.urlStateSubscription) {
            this.urlStateSubscription.unsubscribe();
        }
        if (this.reduxSubscription) {
            this.reduxSubscription.unsubscribe();
        }
        this.initialized = false;
    }
    /**
     * Initialize the bindings between \@angular-redux/router and \@angular/router
     *
     * This should only be called once for the lifetime of your app, for
     * example in the constructor of your root component.
     *
     *
     * @param {?=} selectLocationFromState Optional: If your
     * router state is in a custom location, supply this argument to tell the
     * bindings where to find the router location in the state.
     * @param {?=} urlState$ Optional: If you have a custom setup
     * when listening to router changes, or use a different router than \@angular/router
     * you can supply this argument as an Observable of the current url state.
     * @return {?}
     */
    initialize(selectLocationFromState = state => state.router, urlState$) {
        if (this.initialized) {
            throw new Error('@angular-redux/router already initialized! If you meant to re-initialize, call destroy first.');
        }
        this.selectLocationFromState = selectLocationFromState;
        this.urlState = urlState$ || this.getDefaultUrlStateObservable();
        this.listenToRouterChanges();
        this.listenToReduxChanges();
        this.initialized = true;
    }
    /**
     * @private
     * @return {?}
     */
    getDefaultUrlStateObservable() {
        return this.router.events.pipe(filter(event => event instanceof NavigationEnd), map(() => this.location.path()), distinctUntilChanged());
    }
    /**
     * @private
     * @param {?=} useInitial
     * @return {?}
     */
    getLocationFromStore(useInitial = false) {
        return (this.selectLocationFromState(this.ngRedux.getState()) ||
            (useInitial ? this.initialLocation : ''));
    }
    /**
     * @private
     * @return {?}
     */
    listenToRouterChanges() {
        /** @type {?} */
        const handleLocationChange = (location) => {
            if (this.currentLocation === location) {
                // Dont dispatch changes if we haven't changed location.
                return;
            }
            this.currentLocation = location;
            if (this.initialLocation === undefined) {
                this.initialLocation = location;
                // Fetch initial location from store and make sure
                // we dont dispath an event if the current url equals
                // the initial url.
                /** @type {?} */
                const locationFromStore = this.getLocationFromStore();
                if (locationFromStore === this.currentLocation) {
                    return;
                }
            }
            this.ngRedux.dispatch({
                type: UPDATE_LOCATION,
                payload: location,
            });
        };
        if (this.urlState) {
            this.urlStateSubscription = this.urlState.subscribe(handleLocationChange);
        }
    }
    /**
     * @private
     * @return {?}
     */
    listenToReduxChanges() {
        /** @type {?} */
        const handleLocationChange = (location) => {
            if (this.initialLocation === undefined) {
                // Wait for router to set initial location.
                return;
            }
            /** @type {?} */
            const locationInStore = this.getLocationFromStore(true);
            if (this.currentLocation === locationInStore) {
                // Dont change router location if its equal to the one in the store.
                return;
            }
            this.currentLocation = location;
            this.router.navigateByUrl(location);
        };
        this.reduxSubscription = this.ngRedux
            .select(state => this.selectLocationFromState(state))
            .pipe(distinctUntilChanged())
            .subscribe(handleLocationChange);
    }
}
NgReduxRouter.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NgReduxRouter.ctorParameters = () => [
    { type: Router },
    { type: NgRedux },
    { type: Location }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    NgReduxRouter.prototype.initialized;
    /**
     * @type {?}
     * @private
     */
    NgReduxRouter.prototype.currentLocation;
    /**
     * @type {?}
     * @private
     */
    NgReduxRouter.prototype.initialLocation;
    /**
     * @type {?}
     * @private
     */
    NgReduxRouter.prototype.urlState;
    /**
     * @type {?}
     * @private
     */
    NgReduxRouter.prototype.urlStateSubscription;
    /**
     * @type {?}
     * @private
     */
    NgReduxRouter.prototype.reduxSubscription;
    /**
     * @type {?}
     * @private
     */
    NgReduxRouter.prototype.selectLocationFromState;
    /**
     * @type {?}
     * @private
     */
    NgReduxRouter.prototype.router;
    /**
     * @type {?}
     * @private
     */
    NgReduxRouter.prototype.ngRedux;
    /**
     * @type {?}
     * @private
     */
    NgReduxRouter.prototype.location;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFuZ3VsYXItcmVkdXgvcm91dGVyLyIsInNvdXJjZXMiOlsicm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUV4RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFHNUMsTUFBTSxPQUFPLGFBQWE7Ozs7OztJQVN4QixZQUNVLE1BQWMsRUFDZCxPQUFxQixFQUNyQixRQUFrQjtRQUZsQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsWUFBTyxHQUFQLE9BQU8sQ0FBYztRQUNyQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBWHBCLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBaUVwQiw0QkFBdUIsR0FBMkIsS0FBSyxDQUFDLEVBQUUsQ0FDaEUsS0FBSyxDQUFDLE1BQU0sQ0FBQztJQXREWixDQUFDOzs7Ozs7OztJQVFKLE9BQU87UUFDTCxJQUFJLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtZQUM3QixJQUFJLENBQUMsb0JBQW9CLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDekM7UUFFRCxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUMxQixJQUFJLENBQUMsaUJBQWlCLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDdEM7UUFFRCxJQUFJLENBQUMsV0FBVyxHQUFHLEtBQUssQ0FBQztJQUMzQixDQUFDOzs7Ozs7Ozs7Ozs7Ozs7O0lBZ0JELFVB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QUMsS0FBSyxDQUFDLENBQUM7YUFDcEQsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7YUFDNUIsU0FBUyxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDckMsQ0FBQzs7O1lBeklGLFVBQVU7Ozs7WUFMYSxNQUFNO1lBSHJCLE9BQU87WUFDUCxRQUFROzs7Ozs7O0lBU2Ysb0NBQTRCOzs7OztJQUM1Qix3Q0FBaUM7Ozs7O0lBQ2pDLHdDQUFpQzs7Ozs7SUFDakMsaUNBQXNDOzs7OztJQUV0Qyw2Q0FBNEM7Ozs7O0lBQzVDLDBDQUF5Qzs7Ozs7SUEyRHpDLGdEQUNlOzs7OztJQXpEYiwrQkFBc0I7Ozs7O0lBQ3RCLGdDQUE2Qjs7Ozs7SUFDN0IsaUNBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmdSZWR1eCB9IGZyb20gJ0Bhbmd1bGFyLXJlZHV4L3N0b3JlJztcbmltcG9ydCB7IExvY2F0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5hdmlnYXRpb25FbmQsIFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBmaWx0ZXIsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFVQREFURV9MT0NBVElPTiB9IGZyb20gJy4vYWN0aW9ucyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOZ1JlZHV4Um91dGVyIHtcbiAgcHJpdmF0ZSBpbml0aWFsaXplZCA9IGZhbHNlO1xuICBwcml2YXRlIGN1cnJlbnRMb2NhdGlvbj86IHN0cmluZztcbiAgcHJpdmF0ZSBpbml0aWFsTG9jYXRpb24/OiBzdHJpbmc7XG4gIHByaXZhdGUgdXJsU3RhdGU/OiBPYnNlcnZhYmxlPHN0cmluZz47XG5cbiAgcHJpdmF0ZSB1cmxTdGF0ZVN1YnNjcmlwdGlvbj86IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSByZWR1eFN1YnNjcmlwdGlvbj86IFN1YnNjcmlwdGlvbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgbmdSZWR1eDogTmdSZWR1eDxhbnk+LFxuICAgIHByaXZhdGUgbG9jYXRpb246IExvY2F0aW9uLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIERlc3Ryb3lzIHRoZSBiaW5kaW5ncyBiZXR3ZWVuIEBhbmd1bGFyLXJlZHV4L3JvdXRlciBhbmQgQGFuZ3VsYXIvcm91dGVyLlxuICAgKiBUaGlzIG1ldGhvZCB1bnN1YnNjcmliZXMgZnJvbSBib3RoIEBhbmd1bGFyLXJlZHV4L3JvdXRlciBhbmQgQGFuZ3VsYXIgcm91dGVyLCBpbiBjYXNlXG4gICAqIHlvdXIgYXBwIG5lZWRzIHRvIHRlYXIgZG93biB0aGUgYmluZGluZ3Mgd2l0aG91dCBkZXN0cm95aW5nIEFuZ3VsYXIgb3IgUmVkdXhcbiAgICogYXQgdGhlIHNhbWUgdGltZS5cbiAgICovXG4gIGRlc3Ryb3koKSB7XG4gICAgaWYgKHRoaXMudXJsU3RhdGVTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMudXJsU3RhdGVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZWR1eFN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5yZWR1eFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIHRoZSBiaW5kaW5ncyBiZXR3ZWVuIEBhbmd1bGFyLXJlZHV4L3JvdXRlciBhbmQgQGFuZ3VsYXIvcm91dGVyXG4gICAqXG4gICAqIFRoaXMgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uY2UgZm9yIHRoZSBsaWZldGltZSBvZiB5b3VyIGFwcCwgZm9yXG4gICAqIGV4YW1wbGUgaW4gdGhlIGNvbnN0cnVjdG9yIG9mIHlvdXIgcm9vdCBjb21wb25lbnQuXG4gICAqXG4gICAqXG4gICAqIEBwYXJhbSBzZWxlY3RMb2NhdGlvbkZyb21TdGF0ZSBPcHRpb25hbDogSWYgeW91clxuICAgKiByb3V0ZXIgc3RhdGUgaXMgaW4gYSBjdXN0b20gbG9jYXRpb24sIHN1cHBseSB0aGlzIGFyZ3VtZW50IHRvIHRlbGwgdGhlXG4gICAqIGJpbmRpbmdzIHdoZXJlIHRvIGZpbmQgdGhlIHJvdXRlciBsb2NhdGlvbiBpbiB0aGUgc3RhdGUuXG4gICAqIEBwYXJhbSB1cmxTdGF0ZSQgT3B0aW9uYWw6IElmIHlvdSBoYXZlIGEgY3VzdG9tIHNldHVwXG4gICAqIHdoZW4gbGlzdGVuaW5nIHRvIHJvdXRlciBjaGFuZ2VzLCBvciB1c2UgYSBkaWZmZXJlbnQgcm91dGVyIHRoYW4gQGFuZ3VsYXIvcm91dGVyXG4gICAqIHlvdSBjYW4gc3VwcGx5IHRoaXMgYXJndW1lbnQgYXMgYW4gT2JzZXJ2YWJsZSBvZiB0aGUgY3VycmVudCB1cmwgc3RhdGUuXG4gICAqL1xuICBpbml0aWFsaXplKFxuICAgIHNlbGVjdExvY2F0aW9uRnJvbVN0YXRlOiAoc3RhdGU6IGFueSkgPT4gc3RyaW5nID0gc3RhdGUgPT4gc3RhdGUucm91dGVyLFxuICAgIHVybFN0YXRlJD86IE9ic2VydmFibGU8c3RyaW5nPiB8IHVuZGVmaW5lZCxcbiAgKSB7XG4gICAgaWYgKHRoaXMuaW5pdGlhbGl6ZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0Bhbmd1bGFyLXJlZHV4L3JvdXRlciBhbHJlYWR5IGluaXRpYWxpemVkISBJZiB5b3UgbWVhbnQgdG8gcmUtaW5pdGlhbGl6ZSwgY2FsbCBkZXN0cm95IGZpcnN0LicsXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuc2VsZWN0TG9jYXRpb25Gcm9tU3RhdGUgPSBzZWxlY3RMb2NhdGlvbkZyb21TdGF0ZTtcblxuICAgIHRoaXMudXJsU3RhdGUgPSB1cmxTdGF0ZSQgfHwgdGhpcy5nZXREZWZhdWx0VXJsU3RhdGVPYnNlcnZhYmxlKCk7XG5cbiAgICB0aGlzLmxpc3RlblRvUm91dGVyQ2hhbmdlcygpO1xuICAgIHRoaXMubGlzdGVuVG9SZWR1eENoYW5nZXMoKTtcbiAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgc2VsZWN0TG9jYXRpb25Gcm9tU3RhdGU6IChzdGF0ZTogYW55KSA9PiBzdHJpbmcgPSBzdGF0ZSA9PlxuICAgIHN0YXRlLnJvdXRlcjtcblxuICBwcml2YXRlIGdldERlZmF1bHRVcmxTdGF0ZU9ic2VydmFibGUoKSB7XG4gICAgcmV0dXJuIHRoaXMucm91dGVyLmV2ZW50cy5waXBlKFxuICAgICAgZmlsdGVyKGV2ZW50ID0+IGV2ZW50IGluc3RhbmNlb2YgTmF2aWdhdGlvbkVuZCksXG4gICAgICBtYXAoKCkgPT4gdGhpcy5sb2NhdGlvbi5wYXRoKCkpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRMb2NhdGlvbkZyb21TdG9yZSh1c2VJbml0aWFsOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5zZWxlY3RMb2NhdGlvbkZyb21TdGF0ZSh0aGlzLm5nUmVkdXguZ2V0U3RhdGUoKSkgfHxcbiAgICAgICh1c2VJbml0aWFsID8gdGhpcy5pbml0aWFsTG9jYXRpb24gOiAnJylcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBsaXN0ZW5Ub1JvdXRlckNoYW5nZXMoKSB7XG4gICAgY29uc3QgaGFuZGxlTG9jYXRpb25DaGFuZ2UgPSAobG9jYXRpb246IHN0cmluZykgPT4ge1xuICAgICAgaWYgKHRoaXMuY3VycmVudExvY2F0aW9uID09PSBsb2NhdGlvbikge1xuICAgICAgICAvLyBEb250IGRpc3BhdGNoIGNoYW5nZXMgaWYgd2UgaGF2ZW4ndCBjaGFuZ2VkIGxvY2F0aW9uLlxuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY3VycmVudExvY2F0aW9uID0gbG9jYXRpb247XG4gICAgICBpZiAodGhpcy5pbml0aWFsTG9jYXRpb24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLmluaXRpYWxMb2NhdGlvbiA9IGxvY2F0aW9uO1xuXG4gICAgICAgIC8vIEZldGNoIGluaXRpYWwgbG9jYXRpb24gZnJvbSBzdG9yZSBhbmQgbWFrZSBzdXJlXG4gICAgICAgIC8vIHdlIGRvbnQgZGlzcGF0aCBhbiBldmVudCBpZiB0aGUgY3VycmVudCB1cmwgZXF1YWxzXG4gICAgICAgIC8vIHRoZSBpbml0aWFsIHVybC5cbiAgICAgICAgY29uc3QgbG9jYXRpb25Gcm9tU3RvcmUgPSB0aGlzLmdldExvY2F0aW9uRnJvbVN0b3JlKCk7XG4gICAgICAgIGlmIChsb2NhdGlvbkZyb21TdG9yZSA9PT0gdGhpcy5jdXJyZW50TG9jYXRpb24pIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgdGhpcy5uZ1JlZHV4LmRpc3BhdGNoKHtcbiAgICAgICAgdHlwZTogVVBEQVRFX0xPQ0FUSU9OLFxuICAgICAgICBwYXlsb2FkOiBsb2NhdGlvbixcbiAgICAgIH0pO1xuICAgIH07XG5cbiAgICBpZiAodGhpcy51cmxTdGF0ZSkge1xuICAgICAgdGhpcy51cmxTdGF0ZVN1YnNjcmlwdGlvbiA9IHRoaXMudXJsU3RhdGUuc3Vic2NyaWJlKGhhbmRsZUxvY2F0aW9uQ2hhbmdlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGxpc3RlblRvUmVkdXhDaGFuZ2VzKCkge1xuICAgIGNvbnN0IGhhbmRsZUxvY2F0aW9uQ2hhbmdlID0gKGxvY2F0aW9uOiBzdHJpbmcpID0+IHtcbiAgICAgIGlmICh0aGlzLmluaXRpYWxMb2NhdGlvbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIC8vIFdhaXQgZm9yIHJvdXRlciB0byBzZXQgaW5pdGlhbCBsb2NhdGlvbi5cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBsb2NhdGlvbkluU3RvcmUgPSB0aGlzLmdldExvY2F0aW9uRnJvbVN0b3JlKHRydWUpO1xuICAgICAgaWYgKHRoaXMuY3VycmVudExvY2F0aW9uID09PSBsb2NhdGlvbkluU3RvcmUpIHtcbiAgICAgICAgLy8gRG9udCBjaGFuZ2Ugcm91dGVyIGxvY2F0aW9uIGlmIGl0cyBlcXVhbCB0byB0aGUgb25lIGluIHRoZSBzdG9yZS5cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmN1cnJlbnRMb2NhdGlvbiA9IGxvY2F0aW9uO1xuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChsb2NhdGlvbik7XG4gICAgfTtcblxuICAgIHRoaXMucmVkdXhTdWJzY3JpcHRpb24gPSB0aGlzLm5nUmVkdXhcbiAgICAgIC5zZWxlY3Qoc3RhdGUgPT4gdGhpcy5zZWxlY3RMb2NhdGlvbkZyb21TdGF0ZShzdGF0ZSkpXG4gICAgICAucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKVxuICAgICAgLnN1YnNjcmliZShoYW5kbGVMb2NhdGlvbkNoYW5nZSk7XG4gIH1cbn1cbiJdfQ==